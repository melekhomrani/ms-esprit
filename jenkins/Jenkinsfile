pipeline {
    agent any

    environment {
        NEXUS_URL = 'http://localhost:8081'
        NEXUS_REPO = 'maven-releases'
        NEXUS_CRED = credentials('nexus-credentials')
    }

        stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Build JARs') {
            steps {
                echo 'Building JARs...'
                sh './jenkins/scripts/build_jars.sh'
            }
        }

        stage('Build Docker Images') {
            steps {
                echo 'Building Docker images...'
                sh './jenkins/scripts/build-docker.sh'
            }
        }

        stage('Push Images to Minikube') {
            steps {
                echo 'Pushing Docker images to Minikube daemon...'
                sh './jenkins/scripts/push-minikube.sh'
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                echo 'Deploying to Kubernetes...'
                sh './jenkins/scripts/deploy-k8s.sh'
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully. All services are built, deployed to Nexus, and running.'
        }
        failure {
            echo 'Pipeline failed.'
            mail to: 'melek@store.com',
                subject: "Jenkins Pipeline Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """\
                    The Jenkins pipeline for ${env.JOB_NAME} has failed.

                    Check details and console output:
                    ${env.BUILD_URL}

                    Action is required.
                    """
        }
    }
}